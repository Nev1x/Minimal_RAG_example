# main.py ‚Äî RAG –Ω–∞ ROSBERTa + Mistral + Qdrant

import os
import re
import textwrap
from typing import List
from dotenv import load_dotenv
from openai import OpenAI
from qdrant_client import QdrantClient
from utils.text_processing import clean_text

from embeddings import get_embeddings

# =====================================================
# 0) –û–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∫–ª–∏–µ–Ω—Ç—ã
# =====================================================
load_dotenv()

HF_TOKEN        = os.getenv("HF_TOKEN")
BASE_URL        = os.getenv("BASE_URL")
MAIN_MODEL      = os.getenv("MAIN_MODEL")
QDRANT_URL      = os.getenv("QDRANT_URL")
COLLECTION_NAME = os.getenv("COLLECTION_NAME")

# –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (—Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏)
SIMILARITY_THRESHOLD = float(os.getenv("SIMILARITY_THRESHOLD", 0.4))
TOP_K                 = int(os.getenv("TOP_K", 3))

missing = [k for k, v in {
    "HF_TOKEN": HF_TOKEN,
    "BASE_URL": BASE_URL,
    "MAIN_MODEL": MAIN_MODEL,
    "QDRANT_URL": QDRANT_URL,
    "COLLECTION_NAME": COLLECTION_NAME,
}.items() if not v]
if missing:
    raise ValueError(f"–ù–µ –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: {', '.join(missing)}")

# LLM (OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç) –∏ Qdrant
llm = OpenAI(base_url=BASE_URL, api_key=HF_TOKEN)
qdrant = QdrantClient(url=QDRANT_URL)

print("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Mistral –∏ Qdrant")


# =====================================================
# 1) –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –≤ Qdrant
#    (Distance.COSINE –∑–∞–¥–∞–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ -> —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–º—É —Å—Ö–æ–¥—Å—Ç–≤—É)
# =====================================================
def get_top_contexts(collection: str, query_vector, top_k: int = 3) -> List[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ payload'–æ–≤ —Ç–æ–ø-k —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.
    –ü—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ search(); –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–Ω–∞—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback.
    """
    # 1) –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å ‚Äî search()
    try:
        hits = qdrant.search(
            collection_name=collection,
            query_vector=query_vector,
            limit=top_k,
            with_payload=True
        )
        # score ‚Äî –∫–æ—Å–∏–Ω—É—Å–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å [0..1] (—á–µ–º –±–ª–∏–∂–µ –∫ 1, —Ç–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ–µ)
        hits = [h for h in hits if getattr(h, "score", 0.0) >= SIMILARITY_THRESHOLD]
        return [getattr(h, "payload", {}) for h in hits]
    except Exception as e:
        print(f"‚ö†Ô∏è search() –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º fallback: {e}")

    # 2) Fallback ‚Äî query_points (—Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
    try:
        qr = qdrant.query_points(
            collection_name=collection,
            query=query_vector.tolist() if hasattr(query_vector, "tolist") else query_vector,
            limit=top_k,
            with_payload=True
        )
        if hasattr(qr, "points"):
            raw = qr.points
        elif isinstance(qr, tuple):
            raw = qr[0]
        else:
            raw = qr

        payloads = []
        for item in raw:
            if hasattr(item, "payload") and isinstance(item.payload, dict):
                payloads.append(item.payload)
            elif isinstance(item, dict) and "payload" in item:
                payloads.append(item["payload"])
        return payloads[:top_k]
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ fallback-–ø–æ–∏—Å–∫–µ: {e}")
        return []


# =====================================================
# 2) –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
# =====================================================
def build_prompt(context: str, question: str) -> str:
    return f"""
–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞. –†–∞–±–æ—Ç–∞–π —Å—Ç—Ä–æ–≥–æ –ø–æ –ö–û–ù–¢–ï–ö–°–¢–£, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–∏—Å—Ç–µ–º–∞.
–ï—Å–ª–∏ –≤ –ö–û–ù–¢–ï–ö–°–¢–ï –Ω–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ ‚Äî —á–µ—Å—Ç–Ω–æ —Å–æ–æ–±—â–∏, —á—Ç–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π.

–ü—Ä–∞–≤–∏–ª–∞:
1) –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç—ã –∏–∑ –ö–û–ù–¢–ï–ö–°–¢–ê (—Å–º. –Ω–∏–∂–µ). –ù–∏–∫–∞–∫–∏—Ö –¥–æ–º—ã—Å–ª–æ–≤ –∏ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
2) –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤–µ–∂–ª–∏–≤–æ –Ω–∞ ¬´–≤—ã¬ª. –û—Ç–≤–µ—Ç ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É: 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å 2‚Äì5 –ª–∞–∫–æ–Ω–∏—á–Ω—ã—Ö —à–∞–≥–æ–≤.
3) –ë–µ–∑ –ª–∏—à–Ω–µ–π —Ä–∞–∑–º–µ—Ç–∫–∏, –±–µ–∑ markdown –∏ —ç–º–æ–¥–∑–∏.
4) –ù–µ –æ–∑–≤—É—á–∏–≤–∞–π —Å—Ç–∞–≤–∫–∏, —Ç–∞—Ä–∏—Ñ—ã, –ª–∏–º–∏—Ç—ã, –∫–æ–º–∏—Å—Å–∏–∏, —Å—Ä–æ–∫–∏, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ –ö–û–ù–¢–ï–ö–°–¢–ï.
5) –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –ü–ò–ù, CVV/CVC, –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã, –ª–æ–≥–∏–Ω—ã/–ø–∞—Ä–æ–ª–∏, –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã, –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
6) –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö/–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–±–∞–ª–∞–Ω—Å, —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏, –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏ —Ç. –ø.) ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç—å –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª ¬´–ü–æ–º–æ—â—å¬ª.
7) –ï—Å–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ö–û–ù–¢–ï–ö–°–¢–ê –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É ‚Äî —Å–æ–æ–±—â–∏ –æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
8) –ï—Å–ª–∏ –≤ payload –µ—Å—Ç—å –ø–æ–ª—è category/question ‚Äî –º–æ–∂–µ—à—å –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ —É–∫–∞–∑–∞—Ç—å ¬´–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ‚Ä¶¬ª.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
‚Äî –°–Ω–∞—á–∞–ª–∞ –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –ø–æ —Ñ–∞–∫—Ç–∞–º –∏–∑ –ö–û–ù–¢–ï–ö–°–¢–ê.
‚Äî –ó–∞—Ç–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–ª–∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–≥–∏.
‚Äî –ó–∞–≤–µ—Ä—à–∏ —Ñ—Ä–∞–∑–æ–π: ¬´–ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —É—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ ‚Äî –ø–æ–¥—Å–∫–∞–∂—É –¥–∞–ª—å—à–µ.¬ª

–ö–û–ù–¢–ï–ö–°–¢:
<CONTEXT_START>
{context}
<CONTEXT_END>

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{question}

–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –ö–û–ù–¢–ï–ö–°–¢–ï –Ω–µ—Ç, –æ—Ç–≤–µ—Ç—å:
¬´–ò–∑–≤–∏–Ω–∏—Ç–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –û—Ç–∫—Ä–æ–π—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫–∞ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Ä–∞–∑–¥–µ–ª–æ–º ‚Äú–ü–æ–º–æ—â—å‚Äù.¬ª
""".strip()


# =====================================================
# 3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM
# =====================================================
def generate_answer(question: str, context: str) -> str:
    system_prompt = build_prompt(context, question)
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": question},
    ]
    completion = llm.chat.completions.create(
        model=MAIN_MODEL,
        temperature=0.2,
        max_tokens=512,
        messages=messages,
    )
    raw = completion.choices[0].message.content
    return clean_text(raw)


# =====================================================
# 4) –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
# =====================================================
def ask_question(user_input: str) -> str:
    # —ç–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ ROSBERTa (embeddings.py)
    query_vec = get_embeddings(user_input)[0]

    # –ø–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (–∫–æ—Å–∏–Ω—É—Å–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å –≤ Qdrant)
    payloads = get_top_contexts(COLLECTION_NAME, query_vec, top_k=TOP_K)
    if not payloads:
        print("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.")
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π."

    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤
    context = "\n\n".join([f"‚Ä¢ {p.get('answer', '')}" for p in payloads if p.get("answer")])

    # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    reply = generate_answer(user_input, context)
    print("\nü§ñ –û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:\n")
    print(textwrap.fill(reply, width=90))
    return reply


# =====================================================
# 5) CLI –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# =====================================================
if __name__ == "__main__":
    print("\nüí¨ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å (–∏–ª–∏ 'exit' –¥–ª—è –≤—ã—Ö–æ–¥–∞).")
    while True:
        q = input("\n–í–∞—à –≤–æ–ø—Ä–æ—Å: ").strip()
        if q.lower() in {"exit", "quit"}:
            print("üëã –í—ã—Ö–æ–¥.")
            break
        ask_question(q)